# load modules
ml mamba
source activate mrtrix3
ml ants
ml fsl


## bias correction 
for ID in $(seq 10002 10150) $(seq 11001 11105); do
    echo "Processing sucject: $i"  
dwibiascorrect ants v2preproc/${i}_v2preproc.mif ants/${i}_v2preproc_unbiased.mif
done

## group normalization
dwinormalise group ants/ template/mask_input/ dwinormalise/dwi_output/ dwinormalise/control_fa_template.mif /dwinormalise/control_fa_template_wm_mask.mif -force

## preproc try again

for ID in $(seq 10002 10150) $(seq 11001 11105); do
    echo "Processing ID: $ID"
    dwi2response tournier ants/${ID}_v2preproc_unbiased.mif v2preproc/wmresponse/${ID}_wm_response.txt 
    dwi2mask ants/${ID}_v2preproc_unbiased.mif dwimask/${ID}_dwi_mask.mif     
done

#ASD group
responsemean v2preproc/wmresponse/*_wm_response.txt ASD_average_response.txt
#control group 
responsemean v2preproc/wmresponse/*_wm_response.txt control_average_response.txt

# step 9 WIP
for ID in $(seq 10002 10150) $(seq 11001 11105); do
    echo "Processing ID: $ID"
dwi2fod csd ants/${ID}_v2preproc_unbiased.mif control_average_response.txt wmfod/${ID}_wmfod.mif -mask dwimask/${ID}_dwi_mask.mif
done


#step 10
population_template wmfod -mask_dir dwimask template2/wmfod_template_vox_125.mif -voxel_size 1.25
population_template wmfod -mask_dir dwimask template3/wmfod_template.mif 

## all together now avg response 9 and 10
responsemean wmresponse_group/*_wm_response.txt group_average_response.txt
for ID in $(seq 10006 10150) $(seq 11001 11105); do
    echo "Processing ID: $ID"
dwi2fod csd ants/${ID}_v2preproc_unbiased.mif group_average_response.txt wmfod/${ID}_wmfod.mif -mask dwimask/${ID}_dwi_mask.mif
done
population_template wmfod -mask_dir dwimask template2/wmfod_template_vox_125.mif -voxel_size 1.25
population_template wmfod -mask_dir dwimask template3/wmfod_template.mif 

# Step 11 through 15 tw
for ID in $(seq 10006 10150) $(seq 11001 11105); do
    echo "Processing ID: $ID"
mrregister wmfod/${ID}_wmfod.mif -mask1 dwimask/${ID}_dwi_mask.mif template3/wmfod_template.mif -nl_warp template3/sub2temp/${ID}_subject2template_warp.mif template3/temp2sub/${ID}_template2subject_warp.mif

# warp to template space
mrtransform IN/dwi_mask_upsampled.mif -warp IN/subject2template_warp.mif -interp nearest -datatype bit IN/dwi_mask_in_template_space.mif
