source activate mrtrix3
module load fsl/6.0.7
module load ants/2.4.0


# Loop from 10030 to 10072
for i in $(seq 10030 10072); do
  echo "Processing subject $i"
  
  # Navigate to the subject directory
  cd ~/DICOMS_1/$i
    
  #compress to image file
  mrconvert DTI32/ $i.nii
  mrconvert $i.nii $i.mif  

  # format for preprocessing
  mrconvert DTI32/$i-vox.mif -vox 2 -coord 3 '0:1:32'
  dwidenoise $i-vox.mif v2vox.mif -noise v2_denoised.mif
  mrcalc v2_denoised.mif v2vox.mif -subtract v2_res.mif

  #fsl shit
  dwifslpreproc v2vox.mif v2preproc.mif -rpe_none -pe_dir AP -readout_time 0.1 -eddy_options " --slm=linear "
  dwi2mask v2preproc.mif - | maskfilter - dilate - | mrconvert - eddy_mask.nii -datatype float32 -strides -1,+2,+3
  dwibiascorrect ants v2preproc.mif v2preproc_unbiased.mif

#ANTS and fixels
dwi2response
dwi2mask
dwi2fod csd
fod2fixel
fod2fixel
fixelcorrespondence fixel_space/v2FD.mif fixel_mask v2_FDpr

#tractography to FOD templates
tckgen -angle 22.5 -maxlen 250 -minlen 10 -power 1.0 v2fod.mif -seed_image v2_tempmask.mif -mask v2_tempmask.mif -select 20000000 -cutoff 0.10 tracks_20_million.tck

 

  echo "Finished processing subject $i"
done
