# load enviorments
ml mamba
source activate mrtrix3
ml fsl

# Preproc sequence loop
for ID in $(seq 10001 10150); do
  echo "Processing subject $ID"

 # Navigate to the subject directory
  cd "$ID" || { echo "Directory $ID not found! Skipping."; continue; }
  #compress to image file
  mrconvert DTI32/ ${ID}.nii
  mrconvert ${ID}.nii ${ID}.mif

  # format DICOMs into mif file voxel size 2
  mrconvert DTI32/ ${ID}_vox.mif -vox 2 -coord 3 '0:1:32' -grad -export_grad_mrtrix path -export_grad_fsl bvecs_path bvals_path
  #denoise images
  dwidenoise ${ID}_vox.mif v2vox.mif -noise v2_denoised.mif
  # calculate residuals
  mrcalc v2_denoised.mif v2vox.mif -subtract v2_res.mif
  
  # fsl preprocessing
  dwifslpreproc v2vox.mif ${ID}_v2preproc.mif -rpe_none -pe_dir AP -readout_time 0.1 -eddy_options " --slm=linear "
  #this badboy is causing clipping issues PFC etc, probably due to denoising 
  dwi2mask ${ID}_v2preproc.mif - | maskfilter - dilate - | mrconvert - eddy_mask.nii -datatype float32 -strides -1,+2,+3 
  cd ..
  done

module unload fsl
ml ants
# bias correction for all subjects which is causing contrast issues
mkdir eddy_afterants
for ID in $(seq 10002 10150) $(seq 11001 11105); do
    echo "Processing sucject: ${ID}"  
  cd "$ID" || { echo "Directory $ID not found! Skipping."; continue; }
# this deals with the shimming. bright white areas
dwibiascorrect {ID}_v2preproc.mif ${ID}_v2preproc_unbiased.mif

cd ..
done

# FIRST I GOTTA LINK STUFF INTO A FOLDER
dwinormalise group ants/ template/mask_input/ dwinormalise/dwi_output/ fa_template.mif fa_template_wm_mask.mif 


# this might be screwy if its normalizing based off the mask. Probably causing more of the contrast issues
dwinormalise group ants/ mask_input/ dwi_output/ fa_template.mif fa_template_wm_mask.mif 

# eddy_afterants was done bc we need it for the poptemplate, and original eddy wasnt normalized
mkdir wmresponse
mkdir dwimask
mkdir eddy_afterants
## 
for ID in $(seq 10002 10150) $(seq 11001 11107); do
    echo "Processing ID: $ID"
    dwi2response tournier dwi_output/${ID}_v2preproc_unbiased.mif wmresponse/${ID}_wm_response.txt 
    dwi2mask dwi_output/${ID}_v2preproc_unbiased.mif dwimask/${ID}_dwimask.mif 
    dwi2mask dwi_output/${ID}_v2preproc_unbiased.mif - | maskfilter - dilate - | mrconvert - eddy_afterants/${ID}_eddy_mask.nii -datatype float32 -strides -1,+2,+3 
done


## generate average wm response
responsemean wmresponse/*_wm_response.txt group_average_response.txt


mkdir wmfod
for ID in $(seq 10002 10150) $(seq 11001 11107); do
    echo "Generating FOD: $ID"
dwi2fod csd dwi_output/${ID}_v2preproc_unbiased.mif group_average_response.txt wmfod/${ID}_wmfod.mif 
done

population_template wmfod/ -mask_dir eddy_afterants/ wmfod_template.mif  

# Register to template
mkdir subj2temp
mkdir temp2subj
mkdir maskintemp
# masks to template 
for ID in $(seq 10002 10150) $(seq 11001 11107); do
mrregister wmfod/${ID}_wmfod.mif -mask1 dwimask/${ID}_dwimask.mif wmfod_template.mif -nl_warp subj2temp/${ID}_subject2template_warp.mif temp2subj/${ID}_template2subject_warp.mif
mrtransform dwimask/${ID}_dwimask.mif -warp subj2temp/${ID}_subject2template_warp.mif -interp nearest -datatype bit maskintemp/${ID}_maskintemp.mif
done
# calculate intersections of all masks
mrmath maskintemp/* min template_mask.mif -datatype bit
# Fixel mask
fod2fixel -mask template_mask.mif -fmls_peak_value 0.10 wmfod_template.mif fixel_mask

mkdir fodintemp_not_reoriented
for ID in $(seq 10002 10150) $(seq 11001 11107); do
mrtransform wmfod/${ID}_wmfod.mif -warp subj2temp/${ID}_subject2template_warp.mif -reorient_fod no fodintemp_not_reoriented/${ID}_fodintemp_NOT_REORIENTED.mif
done

# fixel reorient and fixel to template
mkdir fixel_in_temp
mkdir fixelintemp_not_reoriented
for ID in $(seq 10002 10150) $(seq 11001 11107); do
fod2fixel -mask template_mask.mif fodintemp_not_reoriented/${ID}_fodintemp_NOT_REORIENTED.mif fixelintemp_not_reoriented/${ID}_fixel_in_template_space_NOT_REORIENTED -afd ${ID}_fd.mif
fixelreorient fixelintemp_not_reoriented/${ID}_fixel_in_template_space_NOT_REORIENTED subj2temp/${ID}_subject2template_warp.mif fixel_in_temp/${ID}_fixel_in_template_space
done

# calculate fd and fc for statistical analysis
mkdir fd
mkdir fc
for ID in $(seq 10002 10150) $(seq 11001 11107); do
fixelcorrespondence fixel_in_temp/${ID}_fixel_in_template_space/${ID}_fd.mif fixel_mask fd/ ${ID}.mif
warp2metric subj2temp/${ID}_subject2template_warp.mif -fc fixel_mask fc/${ID} ${ID}.mif
done

# calculate log fc, I copied the files from fc to log_fc with SOLs gooey interface instead of shell cause i had to check shit anyway, so I'll add that as code later fuck you
mkdir log_fc/
cp fc/index.mif fdc
cp fc/directions.mif fdc


# Calculate logfc
for ID in $(seq 10002 10150) $(seq 11001 11107); do
 mrcalc fc/${ID}.mif -log log_fc/${ID}.mif
done
# fdc setup
mkdir fdc
cp fc/index.mif fdc
cp fc/directions.mif fdc

# after all that fuckery now we finally calculate fdc
for ID in $(seq 10002 10150) $(seq 11001 11107); do
mrcalc fd/${ID}.mif fc/${ID}.mif -mult fdc/${ID}.mif
done

### whole brain tractography
tckgen -angle 22.5 -maxlen 250 -minlen 10 -power 1.0 wmfod_template.mif -seed_image template_mask.mif -mask template_mask.mif -select 20000000 -cutoff 0.10 tracks_20_million.tck
tcksift tracks_20_million.tck wmfod_template.mif tracks_2_million_sift.tck -term_number 2000000
#generate connectivity matrix
fixelconnectivity fixel_mask/ tracks_2_million_sift.tck matrix/

#smooth it out
fixelfilter fd smooth fd_smooth -matrix matrix/
fixelfilter log_fc smooth log_fc_smooth -matrix matrix/
fixelfilter fdc smooth fdc_smooth -matrix matrix/

## get the file names, I deleted the direction and index files from the list
ls fdc_smooth > files.txt

#statistical dicksucking
fixelcfestats fd_smooth/ files.txt design_group.txt contrast_group.txt matrix/ stats_fd_nocov/ 
fixelcfestats log_fc_smooth/ files.txt design_group.txt contrast_group.txt matrix/ stats_logfc_nocov/ 
fixelcfestats fdc_smooth/ files.txt design_group.txt contrast_group.txt matrix/ stats_fdc_nocov/ 

## Using age as a covariate
fixelcfestats fd_smooth/ files.txt design_agecov.txt contrast_agecov.txt matrix/ stats_fd_agecov/ 
fixelcfestats log_fc_smooth/ files.txt design_agecov.txt contrast_agecov.txt matrix/ stats_log_fc_agecov/ 
fixelcfestats fdc_smooth/ files.txt design_agecov.txt contrast_agecov.txt matrix/ stats_fdc_agecov/ 
